<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.base.mapper.ProjectsMapper">


    <resultMap id="getProjectDTO" type="com.base.dto.ProjectDTO">
        <id column="project_id" property="projectId"/>
        <result column="project_name" property="projectName"/>
        <result column="project_content" property="projectContent"/>
        <result column="project_create" property="createDate"/>
        <result column="project_type" property="projectType"/>
        <result column="project_state" property="projectState"/>
        <collection property="team" ofType="com.base.entity.Teams">
            <id column="team_id" property="teamId"/>
            <result column="create_date" property="createDate"/>
            <result column="team_name" property="teamName"/>
            <result column="team_state" property="teamState"/>
        </collection>
    </resultMap>

    <select id="getAll" resultMap="getProjectDTO">
        select p2.project_id,p2.project_content,p2.project_create
             ,p2.project_name,p2.project_state,p2.project_type,t.*
        from projects p2
        inner join teams t on p2.team_id=t.team_id
    </select>

    <select id="getAllPublic" resultMap="getProjectDTO">
        select p2.project_id,p2.project_content,p2.project_create
             ,p2.project_name,p2.project_state,p2.project_type,t.*
            from (
                select * from projects p
                    where p.project_state=#{project_state}
                ) as p2
            inner join teams t on p2.team_id=t.team_id
    </select>


    <select id="getMyProject" resultMap="getProjectDTO">
        select p2.project_id,p2.project_content,p2.project_create
             ,p2.project_name,p2.project_state,p2.project_type,t.*
        from (
            select * from projects p
                where p.project_state=#{project_state}
                and p.team_id in (
                    select team_id from team_user where user_id=#{user_id}
                )
            ) as p2
        inner join teams t on p2.team_id=t.team_id
    </select>

    <update id="updateByProject">
        update projects
        <set>
            <if test="project.projectName != null and project.projectName != ''">
                project_name=#{project.projectName},
            </if>
            <if test="project.projectContent != null and project.projectContent != ''">
                project_content=#{project.projectContent},
            </if>
            <if test="project.projectType != null and project.projectType != ''">
                project_type=#{project.projectType},
            </if>
            <if test="project.teamId != null and project.teamId != ''">
                team_id=#{project.teamId},
            </if>
        </set>
        where project_id=#{project.projectId};
    </update>

</mapper>
